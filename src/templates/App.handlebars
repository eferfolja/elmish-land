{{Autogenerated}}
module {{RootModule}}.App

open Elmish
open Elmish.React
open Elmish.HMR
open Feliz
open Feliz.Router
open {{RootModule}}.Routes
open {{RootModule}}.Shared

[<RequireQualifiedAccess>]
type Page =
    {{#each Routes}}
    | {{Name}} of {{ModuleName}}.Model
    {{/each}}
    | NotFound

type Model = {
    Shared: SharedModel
    CurrentRoute: Route
    CurrentPage: Page
}

type Msg =
| SharedMsg of SharedMsg
| RouteChanged of Route
{{#each Routes}}
| {{MsgName}} of {{ModuleName}}.Msg
{{/each}}

let init () =
    let initialUrl = Route.parse (Router.currentUrl ())
    let sharedModel, sharedCmd = Shared.init ()

    let defaultModel = {
        Shared = sharedModel
        CurrentRoute = initialUrl
        CurrentPage = Page.NotFound
    }

    let initPageWithArgs init initArgs query page msg =
        let nextModel, nextCmd = init sharedModel initArgs query
        let nextPage = page nextModel

        {
            defaultModel with
                CurrentPage = nextPage
        },
        Command.batch [ sharedCmd; Command.map msg nextCmd ] |> Command.toCmd SharedMsg

    let initPageWithoutArgs init query page msg =
        let nextModel, nextCmd = init sharedModel query
        let nextPage = page nextModel

        {
            defaultModel with
                CurrentPage = nextPage
        },
        Command.batch [ sharedCmd; Command.map msg nextCmd ] |> Command.toCmd SharedMsg

    match initialUrl with
    {{#each Routes}}
    | Route.{{Name}} ({{#if ArgsPattern}}{{ArgsPattern}}, {{/if}}query) ->
        {{#if ArgsUsage}}
        initPageWithArgs {{ModuleName}}.init ({{ArgsUsage}}) query Page.{{Name}} {{MsgName}}
        {{else}}
        initPageWithoutArgs {{ModuleName}}.init query Page.{{Name}} {{MsgName}}
        {{/if}}
    {{/each}}
    | Route.NotFound ->
        {
            defaultModel with
                CurrentPage = Page.NotFound
        },
        Cmd.none

let update (msg: Msg) (model: Model) =
    let updatePage update msg' model' page msg =
        let model'', cmd = update model.Shared msg' model'

        {
            model with
                CurrentPage = page model''
        },
        Command.map msg cmd |> Command.toCmd SharedMsg
    match msg, model.CurrentPage with
    | SharedMsg msg', _ ->
        let model'', cmd = Shared.update msg' model.Shared
        { model with Shared = model'' }, Command.map SharedMsg cmd |> Command.toCmd SharedMsg
    | RouteChanged nextRoute, _ ->
        let changeRouteWithArgs init initArgs query page msg =
            let model', msg' = init model.Shared initArgs query
            {
                model with
                    CurrentPage = page model'
                    CurrentRoute = nextRoute
            },
            Command.map msg msg' |> Command.toCmd SharedMsg
        let changeRouteWithoutArgs init query page msg =
            let model', msg' = init model.Shared query
            {
                model with
                    CurrentPage = page model'
                    CurrentRoute = nextRoute
            },
            Command.map msg msg' |> Command.toCmd SharedMsg
        match nextRoute with
        {{#each Routes}}
        | Route.{{Name}} ({{#if ArgsPattern}}{{ArgsPattern}}, {{/if}}query) ->
            {{#if ArgsUsage}}
            changeRouteWithArgs {{ModuleName}}.init ({{ArgsUsage}}) query Page.{{Name}} {{MsgName}}
            {{else}}
            changeRouteWithoutArgs {{ModuleName}}.init query Page.{{Name}} {{MsgName}}
            {{/if}}
        {{/each}}
        | Route.NotFound ->
            {
                model with
                    CurrentPage = Page.NotFound
                    CurrentRoute = Route.NotFound
            },
            Cmd.none
    {{#each Routes}}
    | {{MsgName}} msg', Page.{{Name}} model' ->
        updatePage {{ModuleName}}.update msg' model' Page.{{Name}} {{MsgName}}
    {{/each}}
    | msg', model' ->
        printfn $"Unhandled App.Msg and CurrentPage.Model. Got\nMsg:\n%A{msg'}\nCurrentPage.Model:\n%A{model'}"
        model, Cmd.none

let view (model: Model) (dispatch: Msg -> unit) =
    let currentPageView =
        match model.CurrentPage with
        {{#each Routes}}
        | Page.{{Name}} m -> {{ModuleName}}.view model.Shared m ({{MsgName}} >> dispatch)
        {{/each}}
        | Page.NotFound -> Html.h1 "Page not found"

    React.router [
        router.onUrlChanged (Route.parse >> RouteChanged >> dispatch)
        router.children [ currentPageView ]
    ]

let subscribe model =
    Sub.batch [
        match model.CurrentPage with
        {{#each Routes}}
        | Page.{{Name}} m -> Sub.map "{{Name}}" {{MsgName}} ({{ModuleName}}.subscribe m)
        {{/each}}
        | Page.NotFound -> Sub.none
    ]

Program.mkProgram init update view
|> Program.withErrorHandler (fun (msg, ex) -> printfn "Program error handler:\r\n%s\r\n%O" msg ex)
|> Program.withReactBatched "app"
|> Program.withSubscription subscribe
|> Program.run
